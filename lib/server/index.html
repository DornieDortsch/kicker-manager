<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font: 13px Helvetica, Arial; }
    form { background: grey; padding: 10px; position: fixed; bottom: 0; width: 100%; }
    form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
    form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    #messages { list-style-type: none; margin: 0; padding: 0; }
    #messages li { padding: 5px 10px; }
    #messages li:nth-child(odd) { background: #eee; }
</style>

<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
  
  <ul id="messages"></ul>
  
  <form action="">
    <input id="m" autocomplete="off" /><button>Send</button>
  </form>

<script>
  var initReady = false
  var $messages = $('#messages')
  var socket = io()

  var createChange = change => {
    return $('<li>').html(
      new Date(change.time).toLocaleTimeString('de-DE') 
      + ' ' 
      + change.type 
      + ' ' 
      + change.player.name 
      + ' ' 
      + ' (' + change.player.offers + ')'
      + ' ' 
      + '<a target="_blank" href="http://manager.kicker.de/pro/Transfermarkt/transfergebot/manliga/2946/manben/3704795/spielerid/' + change.player.id + '/action/1#ctl00_PlaceHolderContent_ctl00_spieler_ProDaten">bieten</a>' 
    )
  }

  var displayDelta = delta => {
    delta.forEach(change => {
      $messages.prepend(createChange(change))
    })
  }

  var displayChanges = changes => {
    $messages.empty()

    changes.forEach(change => {
      $messages.append(createChange(change))
    })
  }


  $('form').submit(() => {

    socket.emit('chat message', $('#m').val())
      
    $('#m').val('')

    return false
  })

  // socket.on('chat message', msg => {
  //   $('#messages').append($('<li>').text(msg))
  // })

  socket.on('tfm.start', data => {
    var changes = JSON.parse(decodeURIComponent(data))
    
    console.log('tfm.start ' + new Date().toLocaleTimeString('de-DE') + ' ' + changes.length)

    displayChanges(changes)
  })

  socket.on('tfm.delta', data => {
    var delta = JSON.parse(decodeURIComponent(data))
    
    console.log('tfm.delta ' + new Date().toLocaleTimeString('de-DE') + ' ' + delta.length)

    displayDelta(delta)
  })

</script>