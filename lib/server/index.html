<style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font: 13px Helvetica, Arial; }
    form { background: grey; padding: 10px; position: fixed; bottom: 0; width: 100%; }
    form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
    form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
    ul { list-style-type: none; margin: 0; padding: 0; border-bottom: 4px solid black }
    ul li { padding: 5px 10px; }
    ul li:nth-child(odd) { background: #eee; }

    #liga li { display: inline-block; }
</style>

<script src="https://code.jquery.com/jquery-1.11.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>

  <ul id="liga"></ul>
  
  <ul id="actions"></ul>
  
  <!--
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
  -->

<script>
  var initReady = false
  var $liga = $('#liga')
  var $actions = $('#actions')
  var socket = io()

  var displayState = state => {
    createLiga(state.liga)
  }

  var createLiga = liga => {
    liga.mitglieder.forEach(id => $liga.append(createMitglied(liga.mitgliederDetail[id])))
  }
  
  var createMitglied = mitglied => {
    return $('<li>').html(
        mitglied.name
        + ' '
        + mitglied.budget
    )
  }

  var displayDelta = delta => {
    delta.forEach(change => {
      $actions.prepend(createChange(change))
    })
  }

  var displayChanges = changes => {
    $actions.empty()

    changes.forEach(change => {
      $actions.append(createChange(change))
    })
  }

  var createChange = change => {
    return $('<li>').html(
      new Date(change.time).toLocaleTimeString('de-DE') 
      + ' ' 
      + change.type 
      + ' ' 
      + change.player.name 
      + ' ' 
      + ' (' + change.player.offers + ')'
      + ' ' 
      + '<a target="_blank" href="http://manager.kicker.de/pro/Transfermarkt/transfergebot/manliga/2946/manben/3704795/spielerid/' + change.player.id + '/action/1#ctl00_PlaceHolderContent_ctl00_spieler_ProDaten">bieten</a>' 
    )
  }


  // $('form').submit(() => {

  //   socket.emit('chat message', $('#m').val())
      
  //   $('#m').val('')

  //   return false
  // })

  // socket.on('chat message', msg => {
  //   $('#messages').append($('<li>').text(msg))
  // })

  socket.on('tfm.start', data => {
    var changes = JSON.parse(decodeURIComponent(data))
    
    console.log('tfm.start ' + new Date().toLocaleTimeString('de-DE') + ' ' + changes.length)

    displayChanges(changes)
  })

  socket.on('tfm.delta', data => {
    var delta = JSON.parse(decodeURIComponent(data))
    
    console.log('tfm.delta ' + new Date().toLocaleTimeString('de-DE') + ' ' + delta.length)

    displayDelta(delta)
  })

  fetch('/data')
  .then(response => response.json())
  .then(displayState);

</script>